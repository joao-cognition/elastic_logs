# Docker Compose file for the application stack
# This file contains several issues for demonstration purposes

version: '3.8'

services:
  # Issue 1: No resource limits defined
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    # Issue 2: Running in privileged mode
    privileged: true
    # Issue 3: Mounting sensitive host directories
    volumes:
      - /etc:/host-etc:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app
    # Issue 4: Exposing all ports to host
    ports:
      - "5000:5000"
      - "22:22"
    # Issue 5: Hardcoded secrets in environment
    environment:
      - DATABASE_URL=postgresql://admin:admin123@database:5432/production_db
      - SECRET_KEY=mysupersecretkey12345
      - DEBUG=true
    # Issue 6: No health check
    # Issue 7: Depends on without health check
    depends_on:
      - database
      - redis
    # Issue 8: No restart policy
    networks:
      - app-network

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    ports:
      - "3000:3000"
      - "80:80"
    environment:
      - API_URL=http://api:5000
      - NODE_ENV=development
    # Issue 9: No read-only root filesystem
    depends_on:
      - api
    networks:
      - app-network

  database:
    build:
      context: .
      dockerfile: Dockerfile.database
    # Issue 10: Exposing database port to host
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin123
      - POSTGRES_DB=production_db
    # Issue 11: No volume for data persistence
    # Issue 12: No backup configuration
    networks:
      - app-network

  redis:
    # Issue 13: Using latest tag
    image: redis:latest
    # Issue 14: No password protection
    ports:
      - "6379:6379"
    # Issue 15: No persistence configuration
    networks:
      - app-network

  # Issue 16: Unnecessary admin tools in production
  adminer:
    image: adminer:latest
    ports:
      - "8080:8080"
    networks:
      - app-network

networks:
  app-network:
    # Issue 17: Using default bridge driver without encryption
    driver: bridge

# Issue 18: No secrets management
# Issue 19: No logging configuration
# Issue 20: No security options (seccomp, apparmor)
