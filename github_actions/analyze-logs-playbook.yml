name: Analyze Logs with Devin Playbook

on:
  push:
    paths:
      - 'logs/**'

jobs:
  trigger-playbook:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get changed log file
        id: changed-file
        run: |
          files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^logs/' | head -n1)
          echo "file=${files}" >> $GITHUB_OUTPUT
      
      - name: Trigger Devin playbook
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          python3 << 'EOF'
          import json
          import os
          from urllib.request import Request, urlopen
          
          api_key = os.environ.get("DEVIN_API_KEY")
          log_file = "${{ steps.changed-file.outputs.file }}"
          
          # Trigger playbook with log file as input
          payload = {
              "prompt": f"Run playbook !logs_analysis on {log_file}",
              "playbook_id": "logs_analysis"
          }
          
          data = json.dumps(payload).encode('utf-8')
          request = Request(
              "https://api.devin.ai/v1/sessions",
              data=data,
              headers={
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json",
              },
              method="POST"
          )
          
          with urlopen(request, timeout=30) as response:
              result = json.loads(response.read().decode('utf-8'))
              print(f"âœ“ Playbook session created")
              print(f"  Session ID: {result['session_id']}")
              print(f"  Session URL: {result['url']}")
          EOF