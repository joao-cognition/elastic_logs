name: Analyze Logs with Devin Playbook

on:
  push:
    paths:
      - 'logs/**'

jobs:
  trigger-playbook:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            logs/*.json
          diff_relative: true
      
      - name: Trigger Devin playbook for each file
        if: steps.changed-files.outputs.all_changed_files != ''
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          python3 << 'EOF'
          import json
          import os
          from urllib.request import Request, urlopen
          
          api_key = os.environ.get("DEVIN_API_KEY")
          files_str = '${{ steps.changed-files.outputs.all_changed_files }}'
          
          if not files_str or files_str == '':
              print("No files to process")
              exit(0)
          
          log_files = files_str.split()
          
          for log_file in log_files:
              print(f"\n=== Processing {log_file} with playbook ===")
              
              # Trigger playbook with log file as input
              payload = {
                  "prompt": f"Run playbook !logs_analysis on {log_file}",
                  "playbook_id": "logs_analysis"
              }
              
              data = json.dumps(payload).encode('utf-8')
              request = Request(
                  "https://api.devin.ai/v1/sessions",
                  data=data,
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "Content-Type": "application/json",
                  },
                  method="POST"
              )
              
              with urlopen(request, timeout=30) as response:
                  result = json.loads(response.read().decode('utf-8'))
                  print(f"  âœ“ Playbook session: {result['url']}")
          EOF
