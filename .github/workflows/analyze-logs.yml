name: Analyze Elastic Logs

on:
  push:
    paths:
      - 'logs/**'
  workflow_dispatch:
    inputs:
      log_file:
        description: 'Path to the log file to analyze'
        required: false
        default: 'logs/elastic_logs.json'
      analyses:
        description: 'Analyses to run (comma-separated: error,security,performance or all)'
        required: false
        default: 'all'

jobs:
  analyze-logs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Determine log file to analyze
        id: log-file
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "log_file=${{ github.event.inputs.log_file }}" >> $GITHUB_OUTPUT
          else
            # Find the most recently modified log file
            LOG_FILE=$(find logs -name "*.json" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
            if [ -z "$LOG_FILE" ]; then
              LOG_FILE="logs/elastic_logs.json"
            fi
            echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT
          fi

      - name: Check for DEVIN_API_KEY
        id: check-key
        run: |
          if [ -n "${{ secrets.DEVIN_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip Analysis (no DEVIN_API_KEY)
        if: steps.check-key.outputs.has_key != 'true'
        run: |
          echo "## Analysis Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "DEVIN_API_KEY is not configured. Skipping Devin analysis steps." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable analysis, add DEVIN_API_KEY as a repository secret:" >> $GITHUB_STEP_SUMMARY
          echo "Settings > Secrets and variables > Actions > New repository secret" >> $GITHUB_STEP_SUMMARY

      - name: Run Error Pattern Analysis
        if: steps.check-key.outputs.has_key == 'true'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          cd ${{ github.workspace }}
          python script/analyze_errors.py --log-file "${{ steps.log-file.outputs.log_file }}"

      - name: Run Security Issue Detection
        if: steps.check-key.outputs.has_key == 'true'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          cd ${{ github.workspace }}
          python script/analyze_security.py --log-file "${{ steps.log-file.outputs.log_file }}"

      - name: Run Performance Anomaly Analysis
        if: steps.check-key.outputs.has_key == 'true'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          cd ${{ github.workspace }}
          python script/analyze_performance.py --log-file "${{ steps.log-file.outputs.log_file }}"

      - name: Upload analysis results
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results-${{ github.run_id }}
          path: analysis/
          retention-days: 30

      - name: Summary
        if: steps.check-key.outputs.has_key == 'true'
        run: |
          echo "## Log Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Log File Analyzed:** ${{ steps.log-file.outputs.log_file }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Analyses Initiated:" >> $GITHUB_STEP_SUMMARY
          echo "- Error Pattern Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Security Issue Detection" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Anomaly Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the Devin sessions for detailed results." >> $GITHUB_STEP_SUMMARY
