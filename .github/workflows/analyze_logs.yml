name: Analyze Elastic Logs

on:
  push:
    paths:
      - 'logs/**'
  workflow_dispatch:
    inputs:
      log_file:
        description: 'Path to the log file to analyze'
        required: false
        default: 'logs/elastic_logs.json'

jobs:
  analyze-errors:
    name: Analyze Application Errors
    runs-on: ubuntu-latest
    if: ${{ secrets.DEVIN_API_KEY != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run error analysis
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          python script/analyze_errors.py ${{ github.event.inputs.log_file || 'logs/elastic_logs.json' }} analysis

      - name: Upload error analysis results
        uses: actions/upload-artifact@v4
        with:
          name: error-analysis-results
          path: analysis/error_analysis_*.json
          if-no-files-found: ignore

  analyze-security:
    name: Analyze Security Issues
    runs-on: ubuntu-latest
    if: ${{ secrets.DEVIN_API_KEY != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run security analysis
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          python script/analyze_security.py ${{ github.event.inputs.log_file || 'logs/elastic_logs.json' }} analysis

      - name: Upload security analysis results
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: analysis/security_analysis_*.json
          if-no-files-found: ignore

  analyze-performance:
    name: Analyze Performance Issues
    runs-on: ubuntu-latest
    if: ${{ secrets.DEVIN_API_KEY != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run performance analysis
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
        run: |
          python script/analyze_performance.py ${{ github.event.inputs.log_file || 'logs/elastic_logs.json' }} analysis

      - name: Upload performance analysis results
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis-results
          path: analysis/performance_analysis_*.json
          if-no-files-found: ignore

  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [analyze-errors, analyze-security, analyze-performance]
    if: ${{ always() && secrets.DEVIN_API_KEY != '' }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Display summary
        run: |
          echo "## Elastic Log Analysis Complete"
          echo ""
          echo "The following analyses were performed:"
          echo "- Error Analysis: Identified application errors and their patterns"
          echo "- Security Analysis: Detected security threats and vulnerabilities"
          echo "- Performance Analysis: Found performance bottlenecks and issues"
          echo ""
          echo "Results are available as workflow artifacts."
          ls -la all-results/ || echo "No results found"
