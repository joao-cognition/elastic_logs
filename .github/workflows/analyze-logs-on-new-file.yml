name: Analyze Logs with Devin

on:
  push:
    paths:
      - 'logs/**'

jobs:
  trigger-devin:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get changed log file
        id: changed-file
        run: |
          files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^logs/' | head -n1)
          echo "file=${files}" >> $GITHUB_OUTPUT
      
      - name: Create issue for Devin to analyze logs
        uses: actions/github-script@v7
        with:
          script: |
            const logFile = '${{ steps.changed-file.outputs.file }}';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Analyze ${logFile}`,
              body: `@devin Please analyze ${logFile}:

            **Error Analysis:**
            - Count all entries with level='ERROR'
            - Group by: status_code, service_name, error_message
            - List top 10 most frequent errors
            - Save as error_report_${timestamp}.html in analysis/

            **Performance Analysis:**
            - Calculate response_time stats: min, max, avg, p95, p99
            - List slowest 10 endpoints
            - Identify any response_time > 1000ms
            - Save as performance_report_${timestamp}.html in analysis/

            **Security Analysis:**
            - Find status_code=401/403 entries
            - Find unique IPs with >10 failed requests
            - Find any SQL/XSS patterns in request_path
            - Save as security_report_${timestamp}.html in analysis/`,
              labels: ['devin']
            });
