# Elastic Logs Analysis Playbook
# This playbook encapsulates three analysis tasks for Elastic Logs:
# 1. Error Pattern Analysis
# 2. Security Issue Detection
# 3. Performance Anomaly Analysis
#
# Usage: This playbook can be triggered via Devin's API using the playbook_id parameter
# or through the GitHub Action workflow.

name: Elastic Logs Analysis Playbook
description: |
  Comprehensive analysis of Elastic Logs to identify errors, security issues,
  and performance anomalies. This playbook runs three specialized analyses
  and generates detailed reports for each category.

version: "1.0.0"

# Input parameters for the playbook
inputs:
  log_file:
    description: Path to the Elastic Log file to analyze
    type: string
    default: logs/elastic_logs.json
    required: false
  
  output_dir:
    description: Directory to save analysis results
    type: string
    default: analysis
    required: false

# Analysis tasks
tasks:
  - name: error_pattern_analysis
    description: Analyze logs for error patterns and failures
    prompt: |
      Analyze the Elastic Logs for error patterns.
      
      Log file: {{ inputs.log_file }}
      
      Perform the following analysis:
      
      1. **Error Frequency Analysis**: Count and categorize all ERROR level logs by:
         - HTTP status code (500, 502, 503, 504, etc.)
         - Service name
         - Error message type
      
      2. **Error Pattern Detection**: Identify recurring error patterns:
         - Look for repeated errors from the same service
         - Identify error cascades (errors that trigger other errors)
         - Find correlation between errors and specific endpoints
      
      3. **Root Cause Analysis**: For each major error category:
         - Identify potential root causes based on error messages and stack traces
         - Suggest remediation steps
      
      4. **Time-based Analysis**: Analyze error distribution over time:
         - Identify any error spikes or clusters
         - Look for patterns in error timing
      
      5. **Impact Assessment**: Assess the impact of errors:
         - Which services are most affected
         - Which endpoints have the highest error rates
         - Estimate user impact based on error frequency
      
      Save your detailed analysis report to {{ inputs.output_dir }}/error_analysis_report.md

  - name: security_issue_detection
    description: Detect security issues and potential threats
    prompt: |
      Analyze the Elastic Logs for security issues.
      
      Log file: {{ inputs.log_file }}
      
      Perform the following security analysis:
      
      1. **Authentication Analysis**: Identify authentication-related issues:
         - Failed login attempts and their frequency
         - Brute force attack patterns (multiple failed attempts from same IP)
         - Unusual authentication patterns (time, location, user agent)
      
      2. **Suspicious IP Detection**: Analyze client IP addresses:
         - Identify IPs with high failure rates
         - Look for known malicious IP patterns
         - Detect IPs attempting to access restricted resources
      
      3. **Injection Attack Detection**: Look for injection attempts:
         - SQL injection patterns in request parameters
         - XSS (Cross-Site Scripting) attempts
         - Command injection attempts
         - Path traversal attempts
      
      4. **Access Control Violations**: Identify unauthorized access attempts:
         - Attempts to access admin endpoints without authorization
         - 401/403 response patterns
         - Privilege escalation attempts
      
      5. **Rate Limiting Analysis**: Analyze request patterns:
         - IPs exceeding rate limits
         - Potential DDoS patterns
         - Automated bot activity indicators
      
      6. **User Agent Analysis**: Examine user agents for:
         - Known attack tools (sqlmap, nikto, etc.)
         - Suspicious or malformed user agents
         - Bot signatures
      
      Categorize findings by severity (Critical, High, Medium, Low).
      Save your detailed security report to {{ inputs.output_dir }}/security_analysis_report.md

  - name: performance_anomaly_analysis
    description: Identify performance anomalies and bottlenecks
    prompt: |
      Analyze the Elastic Logs for performance anomalies.
      
      Log file: {{ inputs.log_file }}
      
      Perform the following performance analysis:
      
      1. **Response Time Analysis**: Analyze HTTP response times:
         - Calculate average, median, p95, and p99 response times per endpoint
         - Identify endpoints with consistently slow response times
         - Detect response time spikes and their correlation with other events
      
      2. **Resource Utilization Analysis**: Examine resource-related logs:
         - Memory usage patterns and potential memory leaks
         - CPU utilization spikes
         - Connection pool exhaustion events
         - Disk I/O latency issues
      
      3. **Database Performance**: Analyze database-related performance:
         - Slow query detection
         - Connection pool utilization
         - Query timeout patterns
      
      4. **Service Health Analysis**: Evaluate service health:
         - Service availability patterns
         - Circuit breaker activations
         - Upstream service failures
      
      5. **Capacity Planning Insights**: Provide capacity-related insights:
         - Peak load times and patterns
         - Resource headroom analysis
         - Scaling recommendations
      
      6. **Performance Trends**: Identify performance trends:
         - Degradation patterns over time
         - Correlation between different performance metrics
         - Seasonal or time-based patterns
      
      Save your detailed performance report to {{ inputs.output_dir }}/performance_analysis_report.md

# Output configuration
outputs:
  reports:
    - "{{ inputs.output_dir }}/error_analysis_report.md"
    - "{{ inputs.output_dir }}/security_analysis_report.md"
    - "{{ inputs.output_dir }}/performance_analysis_report.md"
  
  summary:
    description: Summary of all analyses
    path: "{{ inputs.output_dir }}/analysis_summary.md"
